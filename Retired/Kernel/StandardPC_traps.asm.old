[BITS 32]

SECTION .text

    SEG_KDATA   equ 2   ; TODO: Check these
    SEG_KCPU    equ 3

alltraps:
  ; Build trap frame.
  push ds
  push es
  push fs
  push gs
  pusha
  
  ; Set up data and per-cpu segments.
  mov SEG_KDATA<<3, ax
  mov ax, ds
  mov ax, es
  mov SEG_KCPU<<3, ax
  mov ax, fs
  mov ax, gs

  ; Call trap(tf), where tf=%esp
  push esp
  call trap
  add $4, esp

  ; Return falls through to trapret...
trapret:
  popa
  pop gs
  pop fs
  pop es
  pop ds
  add 0x8, esp  ; trapno and errcode
  iret

; handlers
vector0:
  push 0
  push 0
  jmp alltraps
vector1:
  push 0
  push 1
  jmp alltraps
vector2:
  push 0
  push 2
  jmp alltraps
vector3:
  push 0
  push 3
  jmp alltraps
vector4:
  push 0
  push 4
  jmp alltraps
vector5:
  push 0
  push 5
  jmp alltraps
vector6:
  push 0
  push 6
  jmp alltraps
vector7:
  push 0
  push 7
  jmp alltraps
vector8:
  push 8
  jmp alltraps
vector9:
  push 0
  push 9
  jmp alltraps
vector10:
  push 10
  jmp alltraps
vector11:
  push 11
  jmp alltraps
vector12:
  push 12
  jmp alltraps
vector13:
  push 13
  jmp alltraps
vector14:
  push 14
  jmp alltraps
vector15:
  push 0
  push 15
  jmp alltraps
vector16:
  push 0
  push 16
  jmp alltraps
vector17:
  push 17
  jmp alltraps
vector18:
  push 0
  push 18
  jmp alltraps
vector19:
  push 0
  push 19
  jmp alltraps
vector20:
  push 0
  push 20
  jmp alltraps
vector21:
  push 0
  push 21
  jmp alltraps
vector22:
  push 0
  push 22
  jmp alltraps
vector23:
  push 0
  push 23
  jmp alltraps
.globl vector24
vector24:
  push 0
  push 24
  jmp alltraps
.globl vector25
vector25:
  push 0
  push 25
  jmp alltraps
.globl vector26
vector26:
  push 0
  push 26
  jmp alltraps
.globl vector27
vector27:
  push 0
  push 27
  jmp alltraps
.globl vector28
vector28:
  push 0
  push 28
  jmp alltraps
.globl vector29
vector29:
  push 0
  push 29
  jmp alltraps
.globl vector30
vector30:
  push 0
  push 30
  jmp alltraps
.globl vector31
vector31:
  push 0
  push 31
  jmp alltraps
.globl vector32
vector32:
  push 0
  push 32
  jmp alltraps
.globl vector33
vector33:
  push 0
  push 33
  jmp alltraps
.globl vector34
vector34:
  push 0
  push 34
  jmp alltraps
.globl vector35
vector35:
  push 0
  push 35
  jmp alltraps
.globl vector36
vector36:
  push 0
  push 36
  jmp alltraps
.globl vector37
vector37:
  push 0
  push 37
  jmp alltraps
.globl vector38
vector38:
  push 0
  push 38
  jmp alltraps
.globl vector39
vector39:
  push 0
  push 39
  jmp alltraps
.globl vector40
vector40:
  push 0
  push 40
  jmp alltraps
.globl vector41
vector41:
  push 0
  push 41
  jmp alltraps
.globl vector42
vector42:
  push 0
  push 42
  jmp alltraps
.globl vector43
vector43:
  push 0
  push 43
  jmp alltraps
.globl vector44
vector44:
  push 0
  push 44
  jmp alltraps
.globl vector45
vector45:
  push 0
  push 45
  jmp alltraps
.globl vector46
vector46:
  push 0
  push 46
  jmp alltraps
.globl vector47
vector47:
  push 0
  push 47
  jmp alltraps
.globl vector48
vector48:
  push 0
  push 48
  jmp alltraps
.globl vector49
vector49:
  push 0
  push 49
  jmp alltraps
.globl vector50
vector50:
  push 0
  push 50
  jmp alltraps
.globl vector51
vector51:
  push 0
  push 51
  jmp alltraps
.globl vector52
vector52:
  push 0
  push 52
  jmp alltraps
.globl vector53
vector53:
  push 0
  push 53
  jmp alltraps
.globl vector54
vector54:
  push 0
  push 54
  jmp alltraps
.globl vector55
vector55:
  push 0
  push 55
  jmp alltraps
.globl vector56
vector56:
  push 0
  push 56
  jmp alltraps
.globl vector57
vector57:
  push 0
  push 57
  jmp alltraps
.globl vector58
vector58:
  push 0
  push 58
  jmp alltraps
.globl vector59
vector59:
  push 0
  push 59
  jmp alltraps
.globl vector60
vector60:
  push 0
  push 60
  jmp alltraps
.globl vector61
vector61:
  push 0
  push 61
  jmp alltraps
.globl vector62
vector62:
  push 0
  push 62
  jmp alltraps
.globl vector63
vector63:
  push 0
  push 63
  jmp alltraps
.globl vector64
vector64:
  push 0
  push 64
  jmp alltraps
.globl vector65
vector65:
  push 0
  push 65
  jmp alltraps
.globl vector66
vector66:
  push 0
  push 66
  jmp alltraps
.globl vector67
vector67:
  push 0
  push 67
  jmp alltraps
.globl vector68
vector68:
  push 0
  push 68
  jmp alltraps
.globl vector69
vector69:
  push 0
  push 69
  jmp alltraps
.globl vector70
vector70:
  push 0
  push 70
  jmp alltraps
.globl vector71
vector71:
  push 0
  push 71
  jmp alltraps
.globl vector72
vector72:
  push 0
  push 72
  jmp alltraps
.globl vector73
vector73:
  push 0
  push 73
  jmp alltraps
.globl vector74
vector74:
  push 0
  push 74
  jmp alltraps
.globl vector75
vector75:
  push 0
  push 75
  jmp alltraps
.globl vector76
vector76:
  push 0
  push 76
  jmp alltraps
.globl vector77
vector77:
  push 0
  push 77
  jmp alltraps
.globl vector78
vector78:
  push 0
  push 78
  jmp alltraps
.globl vector79
vector79:
  push 0
  push 79
  jmp alltraps
.globl vector80
vector80:
  push 0
  push 80
  jmp alltraps
.globl vector81
vector81:
  push 0
  push 81
  jmp alltraps
.globl vector82
vector82:
  push 0
  push 82
  jmp alltraps
.globl vector83
vector83:
  push 0
  push 83
  jmp alltraps
.globl vector84
vector84:
  push 0
  push 84
  jmp alltraps
.globl vector85
vector85:
  push 0
  push 85
  jmp alltraps
.globl vector86
vector86:
  push 0
  push 86
  jmp alltraps
.globl vector87
vector87:
  push 0
  push 87
  jmp alltraps
.globl vector88
vector88:
  push 0
  push 88
  jmp alltraps
.globl vector89
vector89:
  push 0
  push 89
  jmp alltraps
.globl vector90
vector90:
  push 0
  push 90
  jmp alltraps
.globl vector91
vector91:
  push 0
  push 91
  jmp alltraps
.globl vector92
vector92:
  push 0
  push 92
  jmp alltraps
.globl vector93
vector93:
  push 0
  push 93
  jmp alltraps
.globl vector94
vector94:
  push 0
  push 94
  jmp alltraps
.globl vector95
vector95:
  push 0
  push 95
  jmp alltraps
.globl vector96
vector96:
  push 0
  push 96
  jmp alltraps
.globl vector97
vector97:
  push 0
  push 97
  jmp alltraps
.globl vector98
vector98:
  push 0
  push 98
  jmp alltraps
.globl vector99
vector99:
  push 0
  push 99
  jmp alltraps
.globl vector100
vector100:
  push 0
  push 100
  jmp alltraps
.globl vector101
vector101:
  push 0
  push 101
  jmp alltraps
.globl vector102
vector102:
  push 0
  push 102
  jmp alltraps
.globl vector103
vector103:
  push 0
  push 103
  jmp alltraps
.globl vector104
vector104:
  push 0
  push 104
  jmp alltraps
.globl vector105
vector105:
  push 0
  push 105
  jmp alltraps
.globl vector106
vector106:
  push 0
  push 106
  jmp alltraps
.globl vector107
vector107:
  push 0
  push 107
  jmp alltraps
.globl vector108
vector108:
  push 0
  push 108
  jmp alltraps
.globl vector109
vector109:
  push 0
  push 109
  jmp alltraps
.globl vector110
vector110:
  push 0
  push 110
  jmp alltraps
.globl vector111
vector111:
  push 0
  push 111
  jmp alltraps
.globl vector112
vector112:
  push 0
  push 112
  jmp alltraps
.globl vector113
vector113:
  push 0
  push 113
  jmp alltraps
.globl vector114
vector114:
  push 0
  push 114
  jmp alltraps
.globl vector115
vector115:
  push 0
  push 115
  jmp alltraps
.globl vector116
vector116:
  push 0
  push 116
  jmp alltraps
.globl vector117
vector117:
  push 0
  push 117
  jmp alltraps
.globl vector118
vector118:
  push 0
  push 118
  jmp alltraps
.globl vector119
vector119:
  push 0
  push 119
  jmp alltraps
.globl vector120
vector120:
  push 0
  push 120
  jmp alltraps
.globl vector121
vector121:
  push 0
  push 121
  jmp alltraps
.globl vector122
vector122:
  push 0
  push 122
  jmp alltraps
.globl vector123
vector123:
  push 0
  push 123
  jmp alltraps
.globl vector124
vector124:
  push 0
  push 124
  jmp alltraps
.globl vector125
vector125:
  push 0
  push 125
  jmp alltraps
.globl vector126
vector126:
  push 0
  push 126
  jmp alltraps
.globl vector127
vector127:
  push 0
  push 127
  jmp alltraps
.globl vector128
vector128:
  push 0
  push 128
  jmp alltraps
.globl vector129
vector129:
  push 0
  push 129
  jmp alltraps
.globl vector130
vector130:
  push 0
  push 130
  jmp alltraps
.globl vector131
vector131:
  push 0
  push 131
  jmp alltraps
.globl vector132
vector132:
  push 0
  push 132
  jmp alltraps
.globl vector133
vector133:
  push 0
  push 133
  jmp alltraps
.globl vector134
vector134:
  push 0
  push 134
  jmp alltraps
.globl vector135
vector135:
  push 0
  push 135
  jmp alltraps
.globl vector136
vector136:
  push 0
  push 136
  jmp alltraps
.globl vector137
vector137:
  push 0
  push 137
  jmp alltraps
.globl vector138
vector138:
  push 0
  push 138
  jmp alltraps
.globl vector139
vector139:
  push 0
  push 139
  jmp alltraps
.globl vector140
vector140:
  push 0
  push 140
  jmp alltraps
.globl vector141
vector141:
  push 0
  push 141
  jmp alltraps
.globl vector142
vector142:
  push 0
  push 142
  jmp alltraps
.globl vector143
vector143:
  push 0
  push 143
  jmp alltraps
.globl vector144
vector144:
  push 0
  push 144
  jmp alltraps
.globl vector145
vector145:
  push 0
  push 145
  jmp alltraps
.globl vector146
vector146:
  push 0
  push 146
  jmp alltraps
.globl vector147
vector147:
  push 0
  push 147
  jmp alltraps
.globl vector148
vector148:
  push 0
  push 148
  jmp alltraps
.globl vector149
vector149:
  push 0
  push 149
  jmp alltraps
.globl vector150
vector150:
  push 0
  push 150
  jmp alltraps
.globl vector151
vector151:
  push 0
  push 151
  jmp alltraps
.globl vector152
vector152:
  push 0
  push 152
  jmp alltraps
.globl vector153
vector153:
  push 0
  push 153
  jmp alltraps
.globl vector154
vector154:
  push 0
  push 154
  jmp alltraps
.globl vector155
vector155:
  push 0
  push 155
  jmp alltraps
.globl vector156
vector156:
  push 0
  push 156
  jmp alltraps
.globl vector157
vector157:
  push 0
  push 157
  jmp alltraps
.globl vector158
vector158:
  push 0
  push 158
  jmp alltraps
.globl vector159
vector159:
  push 0
  push 159
  jmp alltraps
.globl vector160
vector160:
  push 0
  push 160
  jmp alltraps
.globl vector161
vector161:
  push 0
  push 161
  jmp alltraps
.globl vector162
vector162:
  push 0
  push 162
  jmp alltraps
.globl vector163
vector163:
  push 0
  push 163
  jmp alltraps
.globl vector164
vector164:
  push 0
  push 164
  jmp alltraps
.globl vector165
vector165:
  push 0
  push 165
  jmp alltraps
.globl vector166
vector166:
  push 0
  push 166
  jmp alltraps
.globl vector167
vector167:
  push 0
  push 167
  jmp alltraps
.globl vector168
vector168:
  push 0
  push 168
  jmp alltraps
.globl vector169
vector169:
  push 0
  push 169
  jmp alltraps
.globl vector170
vector170:
  push 0
  push 170
  jmp alltraps
.globl vector171
vector171:
  push 0
  push 171
  jmp alltraps
.globl vector172
vector172:
  push 0
  push 172
  jmp alltraps
.globl vector173
vector173:
  push 0
  push 173
  jmp alltraps
.globl vector174
vector174:
  push 0
  push 174
  jmp alltraps
.globl vector175
vector175:
  push 0
  push 175
  jmp alltraps
.globl vector176
vector176:
  push 0
  push 176
  jmp alltraps
.globl vector177
vector177:
  push 0
  push 177
  jmp alltraps
.globl vector178
vector178:
  push 0
  push 178
  jmp alltraps
.globl vector179
vector179:
  push 0
  push 179
  jmp alltraps
.globl vector180
vector180:
  push 0
  push 180
  jmp alltraps
.globl vector181
vector181:
  push 0
  push 181
  jmp alltraps
.globl vector182
vector182:
  push 0
  push 182
  jmp alltraps
.globl vector183
vector183:
  push 0
  push 183
  jmp alltraps
.globl vector184
vector184:
  push 0
  push 184
  jmp alltraps
.globl vector185
vector185:
  push 0
  push 185
  jmp alltraps
.globl vector186
vector186:
  push 0
  push 186
  jmp alltraps
.globl vector187
vector187:
  push 0
  push 187
  jmp alltraps
.globl vector188
vector188:
  push 0
  push 188
  jmp alltraps
.globl vector189
vector189:
  push 0
  push 189
  jmp alltraps
.globl vector190
vector190:
  push 0
  push 190
  jmp alltraps
.globl vector191
vector191:
  push 0
  push 191
  jmp alltraps
.globl vector192
vector192:
  push 0
  push 192
  jmp alltraps
.globl vector193
vector193:
  push 0
  push 193
  jmp alltraps
.globl vector194
vector194:
  push 0
  push 194
  jmp alltraps
.globl vector195
vector195:
  push 0
  push 195
  jmp alltraps
.globl vector196
vector196:
  push 0
  push 196
  jmp alltraps
.globl vector197
vector197:
  push 0
  push 197
  jmp alltraps
.globl vector198
vector198:
  push 0
  push 198
  jmp alltraps
.globl vector199
vector199:
  push 0
  push 199
  jmp alltraps
.globl vector200
vector200:
  push 0
  push 200
  jmp alltraps
.globl vector201
vector201:
  push 0
  push 201
  jmp alltraps
.globl vector202
vector202:
  push 0
  push 202
  jmp alltraps
.globl vector203
vector203:
  push 0
  push 203
  jmp alltraps
.globl vector204
vector204:
  push 0
  push 204
  jmp alltraps
.globl vector205
vector205:
  push 0
  push 205
  jmp alltraps
.globl vector206
vector206:
  push 0
  push 206
  jmp alltraps
.globl vector207
vector207:
  push 0
  push 207
  jmp alltraps
.globl vector208
vector208:
  push 0
  push 208
  jmp alltraps
.globl vector209
vector209:
  push 0
  push 209
  jmp alltraps
.globl vector210
vector210:
  push 0
  push 210
  jmp alltraps
.globl vector211
vector211:
  push 0
  push 211
  jmp alltraps
.globl vector212
vector212:
  push 0
  push 212
  jmp alltraps
.globl vector213
vector213:
  push 0
  push 213
  jmp alltraps
.globl vector214
vector214:
  push 0
  push 214
  jmp alltraps
.globl vector215
vector215:
  push 0
  push 215
  jmp alltraps
.globl vector216
vector216:
  push 0
  push 216
  jmp alltraps
.globl vector217
vector217:
  push 0
  push 217
  jmp alltraps
.globl vector218
vector218:
  push 0
  push 218
  jmp alltraps
.globl vector219
vector219:
  push 0
  push 219
  jmp alltraps
.globl vector220
vector220:
  push 0
  push 220
  jmp alltraps
.globl vector221
vector221:
  push 0
  push 221
  jmp alltraps
.globl vector222
vector222:
  push 0
  push 222
  jmp alltraps
.globl vector223
vector223:
  push 0
  push 223
  jmp alltraps
.globl vector224
vector224:
  push 0
  push 224
  jmp alltraps
.globl vector225
vector225:
  push 0
  push 225
  jmp alltraps
.globl vector226
vector226:
  push 0
  push 226
  jmp alltraps
.globl vector227
vector227:
  push 0
  push 227
  jmp alltraps
.globl vector228
vector228:
  push 0
  push 228
  jmp alltraps
.globl vector229
vector229:
  push 0
  push 229
  jmp alltraps
.globl vector230
vector230:
  push 0
  push 230
  jmp alltraps
.globl vector231
vector231:
  push 0
  push 231
  jmp alltraps
.globl vector232
vector232:
  push 0
  push 232
  jmp alltraps
.globl vector233
vector233:
  push 0
  push 233
  jmp alltraps
.globl vector234
vector234:
  push 0
  push 234
  jmp alltraps
.globl vector235
vector235:
  push 0
  push 235
  jmp alltraps
.globl vector236
vector236:
  push 0
  push 236
  jmp alltraps
.globl vector237
vector237:
  push 0
  push 237
  jmp alltraps
.globl vector238
vector238:
  push 0
  push 238
  jmp alltraps
.globl vector239
vector239:
  push 0
  push 239
  jmp alltraps
.globl vector240
vector240:
  push 0
  push 240
  jmp alltraps
.globl vector241
vector241:
  push 0
  push 241
  jmp alltraps
.globl vector242
vector242:
  push 0
  push 242
  jmp alltraps
.globl vector243
vector243:
  push 0
  push 243
  jmp alltraps
.globl vector244
vector244:
  push 0
  push 244
  jmp alltraps
.globl vector245
vector245:
  push 0
  push 245
  jmp alltraps
.globl vector246
vector246:
  push 0
  push 246
  jmp alltraps
.globl vector247
vector247:
  push 0
  push 247
  jmp alltraps
.globl vector248
vector248:
  push 0
  push 248
  jmp alltraps
.globl vector249
vector249:
  push 0
  push 249
  jmp alltraps
.globl vector250
vector250:
  push 0
  push 250
  jmp alltraps
.globl vector251
vector251:
  push 0
  push 251
  jmp alltraps
.globl vector252
vector252:
  push 0
  push 252
  jmp alltraps
.globl vector253
vector253:
  push 0
  push 253
  jmp alltraps
.globl vector254
vector254:
  push 0
  push 254
  jmp alltraps
.globl vector255
vector255:
  push 0
  push 255
  jmp alltraps

# vector table
.data
.globl vectors
vectors:
  .long vector0
  .long vector1
  .long vector2
  .long vector3
  .long vector4
  .long vector5
  .long vector6
  .long vector7
  .long vector8
  .long vector9
  .long vector10
  .long vector11
  .long vector12
  .long vector13
  .long vector14
  .long vector15
  .long vector16
  .long vector17
  .long vector18
  .long vector19
  .long vector20
  .long vector21
  .long vector22
  .long vector23
  .long vector24
  .long vector25
  .long vector26
  .long vector27
  .long vector28
  .long vector29
  .long vector30
  .long vector31
  .long vector32
  .long vector33
  .long vector34
  .long vector35
  .long vector36
  .long vector37
  .long vector38
  .long vector39
  .long vector40
  .long vector41
  .long vector42
  .long vector43
  .long vector44
  .long vector45
  .long vector46
  .long vector47
  .long vector48
  .long vector49
  .long vector50
  .long vector51
  .long vector52
  .long vector53
  .long vector54
  .long vector55
  .long vector56
  .long vector57
  .long vector58
  .long vector59
  .long vector60
  .long vector61
  .long vector62
  .long vector63
  .long vector64
  .long vector65
  .long vector66
  .long vector67
  .long vector68
  .long vector69
  .long vector70
  .long vector71
  .long vector72
  .long vector73
  .long vector74
  .long vector75
  .long vector76
  .long vector77
  .long vector78
  .long vector79
  .long vector80
  .long vector81
  .long vector82
  .long vector83
  .long vector84
  .long vector85
  .long vector86
  .long vector87
  .long vector88
  .long vector89
  .long vector90
  .long vector91
  .long vector92
  .long vector93
  .long vector94
  .long vector95
  .long vector96
  .long vector97
  .long vector98
  .long vector99
  .long vector100
  .long vector101
  .long vector102
  .long vector103
  .long vector104
  .long vector105
  .long vector106
  .long vector107
  .long vector108
  .long vector109
  .long vector110
  .long vector111
  .long vector112
  .long vector113
  .long vector114
  .long vector115
  .long vector116
  .long vector117
  .long vector118
  .long vector119
  .long vector120
  .long vector121
  .long vector122
  .long vector123
  .long vector124
  .long vector125
  .long vector126
  .long vector127
  .long vector128
  .long vector129
  .long vector130
  .long vector131
  .long vector132
  .long vector133
  .long vector134
  .long vector135
  .long vector136
  .long vector137
  .long vector138
  .long vector139
  .long vector140
  .long vector141
  .long vector142
  .long vector143
  .long vector144
  .long vector145
  .long vector146
  .long vector147
  .long vector148
  .long vector149
  .long vector150
  .long vector151
  .long vector152
  .long vector153
  .long vector154
  .long vector155
  .long vector156
  .long vector157
  .long vector158
  .long vector159
  .long vector160
  .long vector161
  .long vector162
  .long vector163
  .long vector164
  .long vector165
  .long vector166
  .long vector167
  .long vector168
  .long vector169
  .long vector170
  .long vector171
  .long vector172
  .long vector173
  .long vector174
  .long vector175
  .long vector176
  .long vector177
  .long vector178
  .long vector179
  .long vector180
  .long vector181
  .long vector182
  .long vector183
  .long vector184
  .long vector185
  .long vector186
  .long vector187
  .long vector188
  .long vector189
  .long vector190
  .long vector191
  .long vector192
  .long vector193
  .long vector194
  .long vector195
  .long vector196
  .long vector197
  .long vector198
  .long vector199
  .long vector200
  .long vector201
  .long vector202
  .long vector203
  .long vector204
  .long vector205
  .long vector206
  .long vector207
  .long vector208
  .long vector209
  .long vector210
  .long vector211
  .long vector212
  .long vector213
  .long vector214
  .long vector215
  .long vector216
  .long vector217
  .long vector218
  .long vector219
  .long vector220
  .long vector221
  .long vector222
  .long vector223
  .long vector224
  .long vector225
  .long vector226
  .long vector227
  .long vector228
  .long vector229
  .long vector230
  .long vector231
  .long vector232
  .long vector233
  .long vector234
  .long vector235
  .long vector236
  .long vector237
  .long vector238
  .long vector239
  .long vector240
  .long vector241
  .long vector242
  .long vector243
  .long vector244
  .long vector245
  .long vector246
  .long vector247
  .long vector248
  .long vector249
  .long vector250
  .long vector251
  .long vector252
  .long vector253
  .long vector254
  .long vector255
